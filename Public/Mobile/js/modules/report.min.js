define(function(require,exports,module){var utils=require("utils");function set_comment_list(comments){var i,ary=[];for(i in comments){ary.push('<li class="list_item"><div class="item_avatar"><a href="index.php/user/p/'+comments[i]["openid"]+'"><img src="'+comments[i]["figureurl_1"]+'" alt=""></a></div>');ary.push('<div class="item_user"><a class="user_name" href="index.php/user/p/'+comments[i]["openid"]+'">'+comments[i]["nickname"]+'</a><p class="user_comment">'+comments[i]["comment"]+"</p></div>");ary.push('<span class="item_time">'+comments[i]["createtime"]+"</span></li>")}$("#comment-list").html(ary.join(""))}function get_comments(id){var url="index.php/report/get_comments/"+id;utils.get(url,function(json){if(json.ret==0){set_comment_list(json.data)}})}function close_report(id,repair){var url="index.php/report/close",data={id:id,repair:repair};utils.post(url,data,function(json){if(json.ret==0){if(repair==1){location.reload()}else{setTimeout(function(){utils.confirm({title:"生成新报告成功",msg:"由于您的复查异议，系统生成了新的漏洞报告，您可以点击前往查看。",confirm_text:"查看新报告",cancel_text:"关闭弹窗",confirm_func:function(){location.href=utils.base_url()+"/index.php/report/detail/"+json.data.newid}})},1000)}}else{utils.alert(json.msg,-1)}})}exports.init=function(page,data){if(page=="add"){if(!data["haslogin"]){utils.show_login_box("系统检测到您还未登录或登录态已失效，请先登录")}setInterval(function(){utils.login_check(function(haslogin){if(!haslogin){utils.show_login_box("系统检测到您还未登录或登录态已失效，请先登录")}})},1800000);$("#holetype").change(function(){var type=$(this).val(),ctypes=data["holechildtypes"][type],i,ary=[];for(i in ctypes){ary.push('<option value="'+i+'">'+ctypes[i]+"</option>")}$("#holechildtype").html(ary.join(""))});$("#report-btn").click(function(){var config=[{id:"holename",name:"漏洞名称",minlen:1,maxlen:50,etype:"input_text",required:true},{id:"holedesc",name:"漏洞详情",minlen:1,maxlen:5000,etype:"input_text",required:true},{id:"captcha",name:"验证码",minlen:4,maxlen:4,etype:"input_text",required:true}];var data=utils.form_check($("#report-error"),config);if(!data){$("#report-error").parent().show();return}data["holetype"]=$("#holetype").val();data["holechildtype"]=$("#holechildtype").val();if($("#allow_protocol").length==1&&!$("#allow_protocol").attr("checked")){utils.show_error_tip("仔细阅读《TSRC用户服务协议》，同意后即可提交漏洞","report-error");return}$("#report-btn").text("提交中...");utils.post("index.php/report/save",data,function(json){if(json.ret==0){var obj={title:"提交漏洞成功",msg:"感谢您提交的漏洞，我们会尽快审核，如审核通过会按照评判标准进行奖励！",confirm_text:"查看详情",cancel_text:"继续提交",confirm_func:function(){location.href=utils.base_url()+"/index.php/report/detail/"+json.data.report_id},cancel_func:function(){location.reload()},close_func:function(){location.reload()}};utils.confirm(obj)}else{utils.show_error_tip(json.msg,"report-error");$("#report-error").parent().show()}},function(){$("#report-btn").text("提交漏洞");$("#captcha-img").attr("src","/index.php/verifycode/index/"+Math.random())})});if(data["title"]){$("#holename").val(data["title"])}if(data["content"]){$("#holedesc").val(data["title"])}}else{if(page=="detail"){get_comments(data["reportid"]);$("#comment-input").keyup(function(event){if(event.keyCode==13&&event.ctrlKey){$("#comment-btn").click()}});$("#comment-btn").click(function(){var comment=$.trim($("#comment-input").val()),url="index.php/report/add_comment",postdata={id:data["reportid"],comment:comment};if(!comment){utils.show_error_tip("请输入您的评论内容","error-tip");$("#error-tip").parent().show();return}if(comment.length>1000){utils.show_error_tip("评论内容不能大于1000个字符","error-tip");$("#error-tip").parent().show();return}$("#comment-btn").text("提交中...");utils.post(url,postdata,function(json){if(json.ret==0){$("#comment-input").val("");get_comments(data["reportid"])}else{utils.show_error_tip(json.msg,"error-tip");$("#error-tip").parent().show()}},function(){$("#comment-btn").text("提交留言")})});$("#report-repair-yes").click(function(){utils.confirm("确认修复","您确认该漏洞已经修复吗？",function(){close_report(data["reportid"],1)})});$("#report-repair-no").click(function(){utils.confirm("复查异议","您认为该漏洞还未修复吗？点击确定将提出复查异议，生成新的漏洞报告以便管理员重新审核",function(){close_report(data["reportid"],0)})});utils.code_break_word("holedesc");utils.auto_img()}}}});