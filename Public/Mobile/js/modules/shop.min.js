define(function(require,exports,module){var utils=require('utils');var _haslogin=false;exports.init=function(page,data){if(page=='index'||page=='search'){utils.search_box_bind('prize-search','prize-search-btn',utils.base_url()+'/index.php/shop/search?keyword={keyword}');$('#flag-list').change(function(){var flag=$(this).val();location.href=utils.base_url()+'/index.php/shop?flag='+flag+'&rangeid='+data['rangeid']+'&orderby='+data['orderby']+'&ordertype='+data['ordertype']+'&show_instore='+data['show_instore'];});$('#coin-range-list').change(function(){var rangeid=$(this).val();location.href=utils.base_url()+'/index.php/shop?flag='+data['flag']+'&rangeid='+rangeid+'&orderby='+data['orderby']+'&ordertype='+data['ordertype']+'&show_instore='+data['show_instore'];});$('#order-list').change(function(){var orderby=$(this).val(),ordertype=orderby==2?1:0;location.href=utils.base_url()+'/index.php/shop?flag='+data['flag']+'&rangeid='+data['rangeid']+'&orderby='+orderby+'&ordertype='+ordertype+'&show_instore='+data['show_instore'];});$('#show-instore-check').click(function(){var show_instore=0;if($(this).attr('checked')){show_instore=1;}else{show_instore=0;}
location.href=utils.base_url()+'/index.php/shop?flag='+data['flag']+'&rangeid='+data['rangeid']+'&orderby='+data['orderby']+'&ordertype='+data['ordertype']+'&show_instore='+show_instore;});$('.prize-btn').on('click',function(){var pid=$(this).attr('pid'),url='index.php/shop/check/'+pid;utils.get(url,function(json){if(json.ret==0){location.href=utils.base_url()+'/index.php/shop/order/'+pid;}else{utils.alert(json.msg,-1);}});});utils.set_pagination('pc-pagination');}else if(page=='order'){utils.modified_box_bind('prize-count','prize-count-plus','prize-count-minus',9,1,function(num){var price=parseInt($('#price').text()),sum=num*price,remain=data['coins']-sum;$('.prize-sum').text(sum);$('#coins-remain').text(remain);});$('.use_discount').click(function(){var use_discount=$('#use_discount').is(':checked')?1:0;if(use_discount){$('#price').text(data['discount_price']);$('#prize-count').val(1);$('#prize-count').keyup();}else{$('#price').text(data['prize_price']);$('#prize-count').keyup();}});if(data['use_discount']){$('#use_discount').attr('checked',true);$('#use_discount').click();}
$('#address-select .mod-address-added').click(function(){$('#address-select .mod-address-added').removeClass('mod-address-active');$(this).addClass('mod-address-active');});$('#address-select .change_setdefault').click(function(){var parent=$(this).parent().parent(),aid=parent.attr('aid')
utils.post('index.php/user/address_set_default',{aid:aid},function(json){if(json.ret==0){location.reload();}else{utils.alert(json.msg,-1)}});});$('.mod-address-add').click(function(){$('.mod-popup-address .content_title').text('新增收货地址');$('.mod-popup-address input[type=text]').val('');$('.mod-popup-address textarea').val('');$('.mod-popup-address').addClass('mod-popup-show');if($('#address-select .mod-address-added-default').length>0){$('#is_default').prop('checked',false);}else{$('#is_default').prop('checked',true);}});$('.i-address-modify').on('click',function(event){var parent=$(this).parent().parent(),classname=parent.attr('class'),aid=parent.attr('aid'),is_default=classname.indexOf('mod-address-added-default')>=0?true:false,truename=parent.find('.acceptor_name').text(),phone=parent.find('.acceptor_phone').text(),address=parent.find('.address_detail').text();$('.mod-popup-address .content_title').text('修改收货地址');$('#address-id').val(aid);$('#truename').val(truename);$('#phone').val(phone);$('#address').val(address);$('#is_default').prop('checked',is_default);$('.mod-popup-address').addClass('mod-popup-show');});$('.mod-popup .i-close').click(function(){$('.mod-popup-address').removeClass('mod-popup-show');});$('.mod-btn-close').click(function(){$('.mod-popup-address').removeClass('mod-popup-show');});utils.input_bind('truename','收件人',1,20);utils.input_bind('phone','手机号码',11,11,'valid_mobile');utils.input_bind('address','详细地址',1,50);$('.mod-popup-address .mod-btn-blue').click(function(){var config=[{id:'truename',name:'收件人',minlen:1,maxlen:20,etype:'input_text',required:true},{id:'phone',name:'手机号码',minlen:11,maxlen:11,etype:'input_text',dtype:'valid_mobile',required:true},{id:'address',name:'详细地址',minlen:1,maxlen:50,etype:'input_text',required:true}];var data=utils.form_check($('#addr-error'),config);if(!data){$('#addr-error').parent().show();return;}
var aid=parseInt($('#address-id').val()),is_default=$('#is_default').attr('checked')?1:0;if(aid){data['aid']=aid;}
data['is_default']=is_default;utils.post('index.php/user/address_save',data,function(json){if(json.ret==0){location.reload();}else{utils.show_error_tip(json.msg,'addr-error');$('#addr-error').parent().show();}});});$('#address-select .i-address-delete').click(function(){var parent=$(this).parent().parent(),aid=parent.attr('aid');utils.confirm('删除确认','您确定要删除该地址吗？',function(){utils.post('index.php/user/address_del',{aid:aid},function(json){if(json.ret==0){location.reload();}else{utils.alert(json.msg,-1)}})});});$('#prize-exchange').click(function(){var pid=data['prize_id'],num=parseInt($.trim($('#prize-count').val())),use_discount=$('#use_discount').is(':checked')?1:0,url='index.php/shop/exchange',total=$('.prize-sum').eq(0).text(),postdata={};if(num<=0){utils.alert('请设置有效数量',-1);return;}
if(data['etype']=='money'){postdata={prize_id:pid,prize_num:num,type:'money'}}else if(data['etype']=='qcoin'){postdata={prize_id:pid,prize_num:num,type:'qcoin'}}else{if(use_discount&&num>1){utils.alert('使用优惠打折只能兑换1件礼品哦',-1);return;}
var aid=$('#address-select .mod-address-active').attr('aid');postdata={prize_id:pid,prize_num:num,addr_id:aid,use_discount:use_discount,type:'prize',};}
utils.confirm('确认兑换','您确定要花费'+total+'安全币兑换该礼品吗？',function(){utils.post(url,postdata,function(json){if(json.ret==0){location.href=utils.base_url()+'/index.php/shop/success/'+json.data.send_id;}else{utils.alert(json.msg,-1);}});});});}else if(page=='prize'){utils.search_box_bind('prize-search','prize-search-btn',utils.base_url()+'/index.php/shop/search?keyword={keyword}');var maxnum=data['store_count']>data['ex_count_p']?data['ex_count_p']:data['store_count'];utils.modified_box_bind('prize-count','prize-count-plus','prize-count-minus',data['store_count'],1,function(num){var price=parseInt($('#price').text()),sum=num*price;$('#total_coins').text(sum);});$('.use_discount').click(function(){var use_discount=$('#use_discount').attr('checked')?1:0;if(use_discount){$('#price').text(data['discount_price']);$('#old-price').show();$('#prize-count').val(1);$('#prize-count').keyup();}else{$('#price').text(data['price']);$('#old-price').hide();$('#prize-count').keyup();}});$('#prize-exchange').click(function(){var pid=data['prize_id'],num=parseInt($.trim($('#prize-count').val())),use_discount=$('#use_discount').attr('checked')?1:0,url='index.php/shop/check/'+pid+'/'+num+'/'+use_discount;if(num<=0){utils.alert('请设置有效数量',-1);return;}
if(use_discount&&num>1){utils.alert('使用优惠打折只能兑换1件礼品哦',-1);return;}
utils.get(url,function(json){if(json.ret==0){location.href=utils.base_url()+'/index.php/shop/order/'+pid+'/'+num+'/'+use_discount;}else{utils.alert(json.msg,-1);}});});}};});